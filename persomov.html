<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ðŸ‘¤ Personajes ðŸ‘¤</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background-color: #E6DAF0;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        .titulo-pagina {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 30px;
            color: #333;
        }
        .enlaces-navegacion {
            margin-bottom: 40px;
        }
        .navegar-boton {
            text-decoration: none;
            padding: 14px 22px;
            margin: 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.3em;
            display: inline-block;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .navegar-boton:hover {
            opacity: 0.8;
            transform: scale(1.1);
        }
        .boton-personajes {
            background-color: #00aa00 !important;
            color: white;
        }
        .personajes-lista {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }
        .personaje {
            width: 180px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            text-align: center;
            padding: 10px;
        }
        .personaje img {
            width: 100%;
            border-radius: 8px;
        }
        .personaje h3 {
            font-size: 1.2em;
            color: #333;
            margin: 10px 0;
        }
        .personaje p {
            font-size: 1em;
            color: #555;
            margin: 5px 0;
        }
        .fuente-datos {
            position: fixed;
            bottom: 5px;
            right: 10px;
            display: flex;
            align-items: center;
            font-size: 15px;
            color: #555;
        }
        .fuente-datos img {
            height: 30px;
            margin-left: 5px;
        }
        .mensaje-cargando {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            color: #555;
            animation: parpadeo 1s infinite;
        }
        @keyframes parpadeo {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body>
    <h1 class="titulo-pagina">ðŸ‘¥ PERSONAJES CINE Y SERIES ðŸ‘¥</h1>
    <div class="enlaces-navegacion">
        <a href="personajes.html" class="navegar-boton boton-personajes">Volver a Personajes ðŸ”™</a>
    </div>
    <div class="mensaje-cargando" id="mensaje-cargando">Cargando la lista de personajes...</div>
    <div class="personajes-lista" id="personajes-lista"></div>
    <div class="fuente-datos">
        Fuente de los datos:
        <img src="Tmdb.new.logo.svg.png" alt="TMDb">
    </div>
    <script>
        const apiKey = '9a36d4ead166703cb424ee2c431342b7';
        const urlBase = `https://api.themoviedb.org/3/person/popular?api_key=${apiKey}&language=es-ES&page=`;
        
        const allowedCountryVariants = {
            "United States": ["united states", "usa", "estados unidos"],
            "Spain": ["spain", "espaÃ±a"],
            "Australia": ["australia"],
            "Canada": ["canada"],
            "United Kingdom": ["united kingdom", "reino unido"], // UK eliminado
            "Ireland": ["ireland", "irlanda", "Ã©ire"]
        };

        function isFromAllowedCountry(placeOfBirth) {
            if (!placeOfBirth) return false;
            const lowerPlace = placeOfBirth.toLowerCase();
            return Object.values(allowedCountryVariants)
                .some(country => country.some(variant => lowerPlace.includes(variant)));
        }

        async function fetchBatchDetails(personIds) {
            try {
                const batchSize = 10;
                const batches = [];
                
                for (let i = 0; i < personIds.length; i += batchSize) {
                    batches.push(personIds.slice(i, i + batchSize));
                }

                const allDetails = [];
                for (const batch of batches) {
                    const promises = batch.map(id => 
                        fetch(`https://api.themoviedb.org/3/person/${id}?api_key=${apiKey}&language=es-ES`)
                            .then(res => res.json())
                    );
                    const results = await Promise.all(promises);
                    allDetails.push(...results.filter(r => r && r.birthday && r.place_of_birth));
                }
                return allDetails;
            } catch (error) {
                console.error("Error en solicitudes batch:", error);
                return [];
            }
        }

        async function cargarPersonajes() {
            const startTime = Date.now();
            let personajes = [];
            let page = 1;
            let totalPages = 1;

            try {
                while (personajes.length < 28 && page <= totalPages) {
                    const response = await fetch(urlBase + page);
                    const data = await response.json();
                    totalPages = data.total_pages;

                    const candidates = data.results
                        .filter(person => person.profile_path && person.popularity >= 0.25);

                    const details = await fetchBatchDetails(candidates.map(p => p.id));
                    
                    const validos = details
                        .filter(d => isFromAllowedCountry(d.place_of_birth))
                        .map(d => ({
                            id: d.id,
                            name: d.name,
                            birthdate: d.birthday.split("-").reverse().join("-"),
                            profile_path: d.profile_path,
                            popularity: d.popularity
                        }));

                    personajes = [...personajes, ...validos]
                        .sort((a, b) => b.popularity - a.popularity)
                        .slice(0, 28);

                    page++;
                }
            } catch (error) {
                console.error("Error general:", error);
            }

            console.log(`Tiempo total: ${(Date.now() - startTime)/1000} segundos`);
            mostrarPersonajes(personajes.slice(0, 28));
        }

        function mostrarPersonajes(personajes) {
            const listaPersonajes = document.getElementById('personajes-lista');
            const mensajeCargando = document.getElementById('mensaje-cargando');
            listaPersonajes.innerHTML = "";

            if (personajes.length === 0) {
                listaPersonajes.innerHTML = "<p>No se encontraron personajes que cumplan los filtros.</p>";
                return;
            }

            mensajeCargando.style.display = 'none';

            personajes.forEach(personaje => {
                const personajeDiv = document.createElement('div');
                personajeDiv.classList.add('personaje');
                personajeDiv.innerHTML = `
                    <a href="https://www.themoviedb.org/person/${personaje.id}" target="_blank">
                        <img src="https://image.tmdb.org/t/p/w500${personaje.profile_path}" alt="${personaje.name}">
                    </a>
                    <h3>${personaje.name} (${personaje.birthdate})</h3>
                    <p>Popularidad: ${personaje.popularity.toFixed(2)}</p>
                `;
                listaPersonajes.appendChild(personajeDiv);
            });
        }

        window.onload = cargarPersonajes;
    </script>
</body>
</html>